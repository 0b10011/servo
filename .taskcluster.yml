version: 1
policy:
  # https://docs.taskcluster.net/docs/reference/integrations/taskcluster-github/docs/taskcluster-yml-v1#pull-requests
  pullRequests: collaborators
tasks:
  - $if: 'tasks_for == "github-push"'
    then:
      taskGroupId: {$eval: as_slugid("decision_task")}
      taskId: {$eval: as_slugid("decision_task")}
      provisionerId: aws-provisioner-v1
      workerType: servo-docker-worker
      created: {$fromNow: ''}
      deadline: {$fromNow: '1 hour'}
      metadata:
        name: "Taskcluster experiments for Servo: decision task"
        description: ""
        owner: ${event.pusher.name}@users.noreply.github.com
        source: ${event.compare}
      scopes:
        - "queue:scheduler-id:taskcluster-github"

        # Granted to role "repo:github.com/servo/servo-taskcluster-experiments:branch:master"
        - "queue:create-task:highest:aws-provisioner-v1/servo-*"
        - "docker-worker:cache:cargo-registry-cache"
        - "docker-worker:cache:cargo-git-cache"

      payload:
        maxRunTime: 1200
        # https://hub.docker.com/r/servobrowser/decision-task/builds/
        # https://github.com/SimonSapin/servo-decision-task-image
        image: "servobrowser/decision-task@sha256:8c9b4de60fc584828ae9a297a780945c2aa505d3b037ead3907554ab2e16aced"
        features:
          taskclusterProxy: true
        env:
          GITHUB_EVENT_OWNER: ${event.pusher.name}@users.noreply.github.com
          GITHUB_EVENT_SOURCE: ${event.compare}
          GITHUB_EVENT_CLONE_URL: ${event.repository.clone_url}
          GITHUB_EVENT_COMMIT_SHA: ${event.after}
        command:
          - /bin/bash
          - '--login'
          - '-c'
          - >-
            git clone $GITHUB_EVENT_CLONE_URL repo &&
            cd repo &&
            git checkout $GITHUB_EVENT_COMMIT_SHA &&
            python2.7 decision-task.py
